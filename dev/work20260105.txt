===============================================================================
行列 30 輸入法 Rust 實作 - 工作記錄
日期: 2025-01-05
===============================================================================

專案位置: W:\rustarray30

===============================================================================
設計文件參考
===============================================================================

設計文件:
- doc/design01.txt - 輸入法核心規格 (行列30鍵盤配置、單字取碼、詞彙輸入規則)
- doc/design02.txt - 資料檔案配置 (詞庫檔、cin2字表)

表格檔案:
- table/array30-phrase-20210725.txt - 詞庫檔 (6萬詞)
- table/cin2/ar30-regular-v2023-1.0-20251012.cin2 - 標準版字表
- table/cin2/ar30-big-v2023-1.0-20251012.cin2 - 大字集版字表
- table/行列字根表v2023.jpg - 字根表圖片

===============================================================================
實作功能總覽
===============================================================================

1. 核心輸入法引擎
   - 行列30鍵盤對應 (30個鍵位)
   - 單字輸入 (1-4碼)
   - 詞彙輸入 (使用 ' 鍵作為詞彙終結符)
   - 候選字列表與翻頁
   - 狀態機管理 (空閒/輸入碼/詞彙輸入/選字)

2. 平台支援
   - Windows: GUI模式 (egui/eframe) + 終端機模式
   - Linux: 終端機模式 (crossterm)

3. 字典與詞庫
   - cin2格式字表解析
   - 詞庫檔解析
   - 快速查找

4. GUI 功能 (Windows)
   - 主輸入畫面
   - 設定面板
   - 字根表顯示
   - 剪貼簿支援

5. 設定管理 (settings.ini)
   - 字型設定 (路徑、大小)
   - 字根表設定 (顯示/隱藏、縮放、位置)
   - 視窗大小 (1600x900 預設)

===============================================================================
專案結構
===============================================================================

src/
├── main.rs          - 主程式入口，命令列參數解析
├── lib.rs           - 函式庫模組匯出
├── keymap.rs        - 行列30鍵盤對應
├── state.rs         - 輸入狀態機 (InputState, Candidate, InputMode)
├── dict.rs          - 字典載入 (詞庫檔、cin2字表)
├── input_engine.rs  - 輸入法引擎核心邏輯
├── config.rs        - 設定檔管理
├── gui.rs           - Windows GUI (egui)
└── console.rs       - Linux 終端機介面

===============================================================================
核心模組說明
===============================================================================

1. keymap.rs - 鍵盤對應
   - Array30Key enum: 30個行列鍵
   - 對應標準英文鍵盤 a-z, ., /, ;, ,
   - from_char(), code_char() 方法

2. state.rs - 狀態管理
   - InputMode: Normal, PhraseInput
   - InputState: 輸入狀態 (raw_keys, composing, output, current_code)
   - Candidate: 候選字/詞

3. dict.rs - 字典
   - Dictionary 結構
   - load_phrase_file(): 載入詞庫
   - load_cin2_file(): 載入字表
   - lookup_chars(), lookup_phrases(): 查找

4. input_engine.rs - 引擎核心
   - InputEngine 結構
   - handle_key(): 處理按鍵
   - select_candidate(): 選擇候選字
   - next_page(), prev_page(): 候選翻頁

5. config.rs - 設定管理
   - Config 結構
   - RootTablePosition enum (Up, Down, Left, Right)
   - load(), save(): INI格式設定檔

6. gui.rs - Windows GUI
   - GuiApp 結構
   - show_main_panel(): 主畫面 (支援4種字根表位置)
   - show_settings_panel(): 設定面板
   - show_main_content(): 主要輸入內容
   - show_root_table_content(): 字根表顯示

===============================================================================
設定檔格式 (settings.ini)
===============================================================================

# Array30 Input Method Settings
# 設定檔

# Font file path (字型檔案路徑)
font_path=C:\Windows\Fonts\MSJH.TTC

# Font size in points (字型大小)
font_size=20

# Show root table image (顯示字根表)
show_root_table=true

# Root table image scale (字根表縮放比例 0.1-2.0)
root_table_scale=0.5

# Window size (視窗大小)
window_width=1600
window_height=900

# Root table position (字根表位置: up/down/left/right)
root_table_position=up

===============================================================================
命令列參數
===============================================================================

  --big, -b       使用大字集字表（預設使用標準版）
  --console, -c   強制使用終端機模式（僅 Windows）
  --gui, -g       強制使用 GUI 模式（僅 Windows，為預設）
  --help, -h      顯示說明

===============================================================================
輸入法規則實作
===============================================================================

1. 單字輸入:
   - 輸入1-4個行列碼
   - 即時顯示候選字
   - 按數字鍵1-9選字
   - 空白鍵或Enter確認第一候選

2. 詞彙輸入:
   - 輸入4碼後按 ' 進入詞彙模式
   - 系統查找詞庫
   - 顯示詞彙候選列表
   - 選擇詞彙上屏

3. 兩字詞取碼: 第一字首尾 + 第二字首尾 (4碼)
4. 三字詞取碼: 第一字首 + 第二字首 + 第三字首尾 (4碼)
5. 多字詞取碼: 首尾首碼 + 中間關鍵字 (4碼)

===============================================================================
字根表顯示功能
===============================================================================

預設啟用，可於設定中調整:

顯示位置:
- 上方 (Up): 字根表在主內容上方
- 下方 (Down): 字根表在主內容下方
- 左側 (Left): 字根表在左側邊欄
- 右側 (Right): 字根表在右側邊欄

縮放範圍: 0.1x - 2.0x (預設 0.5x)

圖片來源: table/行列字根表v2023.jpg

===============================================================================
建置與執行
===============================================================================

建置:
  cargo build
  cargo build --release

執行:
  cargo run --release                 # Windows GUI 模式
  cargo run --release -- --console    # Windows 終端機模式
  cargo run --release -- --big        # 使用大字集

===============================================================================
依賴套件 (Cargo.toml)
===============================================================================

[dependencies]
crossterm = "0.28"     # 終端機處理
dirs = "6.0.0"           # 設定目錄
ini = "1.3.0"            # INI 解析
serde = "1.0.228"        # 序列化
serde_json = "1.0.148"

# Windows GUI
[target.'cfg(windows)'.dependencies]
egui = "0.29"
eframe = "0.29"
arboard = "3.4"          # 剪貼簿

# 圖片處理
image = { version = "0.25", features = ["jpeg"] }

phf = { version = "0.11", features = ["macros"] }
regex = "1"

===============================================================================
使用說明
===============================================================================

GUI 模式 (Windows):
1. 啟動程式自動以 GUI 模式開啟
2. 直接輸入行列碼 (a-z, ., /, ;, ,)
3. 按 ' 進入詞彙輸入模式
4. 數字鍵 1-9 選擇候選字
5. 空白鍵或Enter確認輸入
6. 可參考字根表進行輸入
7. 設定中可調整字型、字根表位置、視窗大小

終端機模式:
- Ctrl+C 或 Ctrl+Q 離開
- 操作方式與 GUI 模式相同

===============================================================================
檔案狀態
===============================================================================

新增檔案:
- src/config.rs - 設定管理模組
- src/gui.rs - Windows GUI 實作
- src/console.rs - Linux 終端機實作

修改檔案:
- src/main.rs - 主程式
- src/lib.rs - 函式庫
- Cargo.toml - 專案配置

未追蹤檔案:
- doc/ (設計文檔)
- table/ (詞庫與字表)

===============================================================================
開發歷程
===============================================================================

1. 初始化專案結構 (cargo init)
2. 實作核心資料結構 (keymap, state, dict, input_engine)
3. 實作 Windows GUI (egui/eframe)
4. 實作 Linux 終端機介面 (crossterm)
5. 新增設定管理 (INI格式)
6. 新增字型設定功能
7. 新增字根表顯示功能
8. 新增視窗大小設定 (1600x900)
9. 新增字根表位置設定 (上/下/左/右)
10. 實作動態版面配置

===============================================================================
已知限制與後續改進
===============================================================================

限制:
- 詞彙模式僅支援4碼固定格式
- 候選翻頁目前使用簡單的索引切換
- GUI 僅支援 Windows 平台

後續可改進:
- 支援更多快捷鍵
- 支援自訂詞庫
- 支援符號輸入 (W+數字)
- 支援繁簡轉換
- 改進候選顯示效率
- 支援詞句預測
- 支援雙擊編碼

===============================================================================
